<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Streaming Rental Skinned NFT</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Cardo:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/css/modal.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet">

    <!-- Web 3 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.0.umd.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ethjs@0.3.4/dist/ethjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <!-- =======================================================
  * Template Name: PhotoFolio - v1.1.0
  * Template URL: https://bootstrapmade.com/photofolio-bootstrap-photography-website-template/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

    <!-- ======= Header ======= -->
    <header id="header" class="header d-flex align-items-center fixed-top">
        <div class="container-fluid d-flex align-items-center justify-content-between">

            <a href="index.html" class="logo d-flex align-items-center  me-auto me-lg-0">
                <!-- Uncomment the line below if you also wish to use an image logo -->
                <img src="assets/img/logo.png" width="48" height="48" alt="SRS NFT">

                <h1>SRS NFT</h1>
            </a>

            <nav id="navbar" class="navbar">
                <ul>
                    <li><a href="index.html" class="active">Home</a></li>
                    <li><a href="#" id="connect_web_3">Connect Web3</a></li>
                </ul>

            </nav>
            <!-- .navbar -->

            <div class="header-social-links">
                <a href="#" class="twitter"><i class="bi bi-twitter"></i></a>
                <a href="#" class="facebook"><i class="bi bi-facebook"></i></a>
                <a href="#" class="instagram"><i class="bi bi-instagram"></i></a>
                <a href="#" class="linkedin"><i class="bi bi-linkedin"></i></i></a>
            </div>
            <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
            <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>

        </div>
        <div class="container">
            <span id="metamask_logo"></span> <span id="show_wallet"></span><span id="dashboard_span">&nbsp;<a href="dashboard.html">Dashboard</a></span>
        </div>
    </header>

    <!-- End Header -->

    <!-- ======= Hero Section ======= -->
    <section id="hero" class="hero d-flex flex-column justify-content-center align-items-center" data-aos="fade" data-aos-delay="1500">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-6 text-center">
                    <h2>Streaming Rental Skinned NFT</h2>
                    Skin your NFT with exciting covers
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-6 text-center">
                    <h2>List your NFT</h2>
                    <table>
                        <tr>
                            <td>NFT Contract</td>
                            <td><input id="nft_contract_listing_field" type="text" placeholder="0x..." class="form-control"></td>
                            <td>NFT Id</td>
                            <td><input id="nft_id_listing_field" type="text" placeholder=" enter id of your NFT " class="form-control"></td>
                        </tr>
                        <tr>
                            <td>Rental Fee</td>
                            <td><input id="rental_fee_listing_field" type="text" placeholder="enter rental fee " class="form-control"></td>
                            <td>Rental Period </td>
                            <td><select id="rental_period_listing_select" class="form-control">
                                    <option>0.25 days</option>
                                    <option>0.5 days</option>
                                    <option>1 days</option>
                                    <option>3 days</option>
                                    <option>5 days</option>
                                    <option>7 days</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Payment Currency</td>
                            <td><select id="payment_erc20_listing_select" class="form-control">
                                <option style="background-image:url(assets/img/android-icon-36x36.png);">USDC</option>
                                <option>USDT</option>
                                <option>DAI</option>
                                <option>DefiDollar</option>
                                <option>Frax</option>
                            </select></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <i class="bi bi-info-circle"></i>
                                <button id="approve_srs_nft_button" type="submit" id="approve_nft_transfer_button" class="btn btn-warning"><small>Approve SRS NFT</small></button>
                                <span id="instruction_arrow_span"><i class="bi bi-arrow-right"></i></span>
                                <button type="submit" id="list_rental_button" class="btn btn-danger">List Your NFT</button>
                                <!-- must be disabled until approved -->
                                <button type="reset" id="clear_button" class="btn btn-primary">clear</button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <span id="listing_message_span">${listing messages}</span>
                            </td>

                        </tr>
                    </table>

                </div>
            </div>
        </div>
    </section>
    <!-- End Hero Section -->

    <main id="main" data-aos="fade" data-aos-delay="1500">

        <!-- ======= Gallery Section ======= -->
        <section id="gallery" class="gallery">
            <div class="container-fluid">

                <div class="row gy-4 justify-content-center" id="nfts_available">


                </div>

            </div>
        </section>
        <!-- End Gallery Section -->

    </main>
    <!-- End #main -->

    <!-- The Modal -->
    <div id="skinNFTModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <center>
                <font color="black">
                    <h2>Rent Skin</h2>
                </font>
            </center>
            <table>
                <tr>
                    <td><font color="black">Skinnable NFT Contract</font></td>
                    <td><input type="text" placeholder="enter your skinnable NFT contract 0x..." class="form-control"></td>
                </tr>
                <tr>
                    <td><font color="black">Skinnable NFT Id</font></td>
                    <td><input type="text" placeholder="enter id of NFT to be skinned " class="form-control"></td>
                </tr>
                <tr>
                    <td><font color="black">Price:</font></td>
                    <td><font color="black"></font></td>
                </tr>
                <tr>
                    <td><font color="black">Currency:</font></td>
                    <td><font color="black"></font></td>
                </tr>
                <tr>
                    <td><font color="black">Period:</font></td>
                    <td><font color="black"></font></td>
                </tr>
                <tr>
                    <td><button type="submit" id="approve_skin_application_button" class="btn btn-warning">Approve Skin Application</button></td>
                    <td><button type="submit" id="approve_payment_erc20_button" class="btn btn-warning">Approve Payment Erc20</button></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button type="submit" id="rent_skin_button" class="btn btn-success">Rent Skin</button></td>
                </tr>
            </table>
        </div>

    </div>


    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
        <div class="container">
            <div class="copyright">
                &copy; Copyright <strong><span>SRS NFT</span></strong>. All Rights Reserved
            </div>
            <div class="credits">
                <!-- All the links in the footer should remain intact. -->
                <!-- You can delete the links only if you purchased the pro version. -->
                <!-- Licensing information: https://bootstrapmade.com/license/ -->
                <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/photofolio-bootstrap-photography-website-template/ -->
                Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
            </div>
        </div>
    </footer>
    <!-- End Footer -->

    <a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

    <div id="preloader">
        <div class="line"></div>
    </div>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>

    <!-- ABI-->
    <script src="assets/js/abi/i_erc20_metadata_abi.js"></script>
    <script src="assets/js/abi/i_erc721_metadata_abi.js"></script>
    <script src="assets/js/abi/i_open_register_abi.js"></script>
    <script src="assets/js/abi/i_skinnable_abi.js"></script>
    <script src="assets/js/abi/i_streaming_rental_abi.js"></script>
    <script src="assets/js/abi/i_srs_nft_marketplace_abi.js"></script>
    <script src="assets/js/abi/i_super_token_registry_abi.js"></script>

    <!-- WEB3 -->
    <script src="assets/js/autoconnect.js"></script>

    <!-- Modal -->
    <script src="assets/js/modal.js"></script>

    <script>
        const nftsAvailable             = ge("nfts_available");
        const nftContractListingField   = ge("nft_contract_listing_field");
        const nftIdListingField         = ge("nft_id_listing_field");
        const rentalFeeListingField     = ge("rental_fee_listing_field");
        const rentalPeriodListingSelect = ge("rental_period_listing_select");
        const paymentERC20ListingSelect = ge("payment_erc20_listing_select");
        const approveNFTTransferButton  = ge("approve_nft_transfer_button");
        const listRentalButton          = ge("list_rental_button");
        listRentalButton.setAttribute("onclick", "listSkin()");
        
        const clearButton               = ge("clear_button");
        const listingMessageSpan        = ge("listing_message_span");

        const approveSkinApplicationButton  = ge("approve_skin_application_button");
        const approvePaymentERC20Button     = ge("approve_payment_erc20_button");

        const rentSkinButton                = ge("rent_skin_button");

        const iOpenRegisterAddress = "0x08C5727dD1162a3Ed6E03e81fB25202E6Ded6faD";
        
        var iOpenRegisterContract; 
        var iSuperTokenRegisterContract; 
        
        var SRSMarketplaceAddress; 
        var iSRSNFTMarketplaceContract; 


        async function configureCoreContracts() {
            // Register 
            iOpenRegisterContract = getContract(iOpenRegisterAbi, iOpenRegisterAddress);
            // Token Registry 
            iOpenRegisterContract.methods.getAddress("RESERVED_SUPER_TOKEN_REGISTRY").call({from : account})
            .then(function(response){
                console.log(response);
                iSuperTokenRegisterContract = getContract(iSuperTokenRegistry, response);
            })
            .catch(function(err){
                console.log(err);
            });
            
            // Market place
            iOpenRegisterContract.methods.getAddress("RESERVED_SRS_NFT_MARKET_PLACE").call({from : account})
            .then(function(response){
                console.log(response);
                SRSMarketplaceAddress = response; 
                iSRSNFTMarketplaceContract = getContract(iSRSNFTMarketplaceAbi, SRSMarketplaceAddress);
            })
            .catch(function(err){
                console.log(err);
            });
        }

        function loadPageData() { 
            loadMarketPlace(); 
        }

        function loadMarketPlace() {
            nftsAvailable.innerHTML = ""; 
            iSRSNFTMarketplaceContract.methods.getListings().call({ from : account})
            .then(function(response){
                console.log(response);
                var listings = response; 
                for(var x = 0; x < listings.length; x++){
                    var listing = listings[x];
                    console.log(listing);
                    loadNFT(listing);
                }
            })
            .catch(function(err){
                console.log(err);
            });
        }

        function loadNFT(listing) {                                                
            var erc20 = getContract(iERC20MetadataAbi, listing.paymentErc20);
            erc20.methods.symbol().call({from : account})
            .then(function(response){
                console.log(response);
                var currency = response; 
                startGalleryBuild(listing, currency);
            })
            .catch(function(err){
                console.log(err);
            });                       
        }

        function startGalleryBuild(listing, currency) {
            var erc721 = getContract(iERC721Abi, listing.nftContract);            
            erc721.methods.getTokenURI(listing.nftId).call({from : account})
            .then(function(response){
                console.log(response);
                fetch(getTokenURI)
                .then(function(response){
                    console.log(response);
                    var json = JSON.parse(response);                               
                    buildGalleryItem(json.image, json.name, listing.rentalFee, currency, listing.period);
                })
                .catch(function(err){
                    console.log(err);
                });
            })
            .catch(function(err){
                console.log(err);
            });
        }

        function buildGalleryItem(imgSrc, imgTitle, price, currency, period) {
            /*<div class="col-xl-3 col-lg-4 col-md-6">
                  <div class="gallery-item h-100">
                    <img src="assets/img/gallery/gallery-15.jpg" class="img-fluid" alt="">
                    <div class="gallery-links d-flex align-items-center justify-content-center">
                      <a href="assets/img/gallery/gallery-15.jpg" title="Gallery 15" class="glightbox preview-link"><i class="bi bi-arrows-angle-expand"></i></a>
                      <a href="gallery-single.html" class="details-link"><i class="bi bi-link-45deg"></i></a>
                    </div>
                  </div>
                </div><!-- End Gallery Item -->

                */

            var d = ce("div");
            d.setAttribute("class", "col-xl-3 col-lg-4 col-md-6");
            var item = ce("div");
            item.setAttribute("class", "gallery-item h-100");
            d.append(item);
            var img = ce("img");
            img.setAttribute("src", imgSrc);
            img.setAttribute("class", "img-fluid");
            img.setAttribute("alt", "title");
            item.append(img);
            var controls = ce("div");
            controls.setAttribute("class", "gallery-links d-flex align-items-center justify-content-center");
            item.append(controls);
            var lightBox = ce("a");
            lightBox.setAttribute("href", imgSrc);
            lightBox.setAttribute("title", imgTitle);
            lightBox.setAttribute("class", "glightbox preview-link");
            var lightBoxIcon = ce("i");
            lightBoxIcon.setAttribute("class", "bi bi-arrows-angle-expand");
            lightBox.append(lightBoxIcon);
            controls.append(lightBox);

            var modalLink = ce("a");
            modalLink.setAttribute("href", "#");
            modalLink.setAttribute("class", "details-link");

            modalLink.onclick = function() {
                modal.style.display = "block";
            }
            var span = document.getElementsByClassName("close")[0];
            span.onclick = function() {
                modal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
            var skinIcon = ce("i");
            skinIcon.setAttribute("class", "bi bi-back");
            modalLink.append(skinIcon);
            controls.append(modalLink);
            controls.append(ce("br"));
            controls.append(text("Price: " + price + " " + currency));
            controls.append(ce("br"));
            controls.append(text("Period: " + period + " day(s)"));


            nftsAvailable.append(d);

        }

        function approveNFTToRentalContractTransfer() {
            var iERC721 = getContract(iERC721MetadataAbi, )
        }

        function listSkin() {
            listingMessageSpan.innerHTML = ""; 
            iSRSNFTMarketplaceContract.methods.postListing(nftContractListingField.value, 
                                                           nftIdListingField.value, 
                                                           rentalFeeListingField.value, 
                                                           rentalPeriodListingSelect.value, 
                                                           paymentERC20ListingSelect.value).send({from : account})
            .then(function(response){
                console.log(response);
                listingMessageSpan.innerHTML = response; 
            })
            .catch(function(err){
                console.log(err);
            });
        }

        function approveRentalPayment(paymentErc20Address, rentalFee) {
            iERC20 = getContract(iERC20MetadataAbi, paymentErc20Address);
            iERC20.methods.approve(SRSMarketplaceAddress, rentalFee ).send({from : account})
            .then(function(response){
                console.log(response);
            })
            .catch(function(err){
                console.log(err);
            });
        }

        function approveSkinApplication() { 
            
        }

        

        function getContract(abi, address){
            return new web3.eth.Contract(abi, address);
        }

        function ge(name) {
            return document.getElementById(name);
        }

        function ce(name) {
            return document.createElement(name);
        }

        function text(txt) {
            return document.createTextNode(txt);
        }
    </script>

</body>

</html>